<!DOCTYPE html>
<html>
	<head>
	<title>Modeling Relationships with Flask-SQLAlchemy | Akshata Mohanty</title>
	<meta name="description" content="" />

	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<meta property="og:title" content="Modeling Relationships with Flask-SQLAlchemy" />
	<meta property="og:description" content="" />
	<meta property="og:image" content="" />
	<meta property="og:image:width" content="400" />
	<meta property="og:image:height" content="300" />
	<meta property="og:type" content="website" />

	<!-- main stylesheet -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="/styles/main.css">

	<link href='https://iamaatoh.com/feed.xml' rel='alternate' type='application/atom+xml'>

		<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111560396-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-111560396-1');
		document.fonts.ready.then((fontFaceSet) => {
			document.body.style.opacity = 1
		});
	</script>
</head>


	<body>
    <nav>
	<a href='/'><h2>&lt;iamaatoh /&gt;</h2></a>
	<div>Learn. Reflect. Engineer.</div>
	<br />
	<hr />
	<ul>
		<li ><a href='/blog' alt="Blog">Blog</a></li>
		<li ><a href='/project' alt="Project">Projects</a></li>
		<li ><a href='/public' alt="Public">Talks & Research</a></li>
		<li ><a href='/contact' alt="Contact">Contact</a></li>
	</ul>
	<hr />
</nav>

		<main>
			<center>
				<small>
					July 23, 2021
				</small>
				<h1>
					Modeling Relationships with Flask-SQLAlchemy
				</h1>
			</center>


			<article>
				<p>Building APIs often requires encoding business concepts and processes. Object-oriented programming makes this easy and effcient by allowing developers to build rich, encapsulated business models. However, APIs often require dealing with databases, some of them being scalar and relational in nature - such as MySQL or Postgres. And that’s where an ORM comes in.</p>

<h1 id="what-is-an-orm">What is an ORM?</h1>

<p>An ORM is an Object Relational Mapper. The purpose of an ORM is to abstract away the underlying database and vendor-specific SQL queries, hence speeding up development.</p>

<p>For this tutorial, we’ll be using <a href="https://flask-sqlalchemy.palletsprojects.com/en/2.x/">Flask-SQLAlchemy</a> (an extension for Flask that adds support for SQLAlchemy ORM)</p>

<h1 id="visualizing-relationships">Visualizing Relationships</h1>

<p>While modelling a database, it is common to use an Entity Relationship Diagram, to visualize the different relationships between the tables.</p>

<p>Between entities, there can be different kinds of relationships,</p>
<ul>
  <li>one-to-one: eg, person1&lt;-partners-&gt;person2 i.e in a monogamous partnership, one partner can have a single partner and vice-versa</li>
  <li>one-to-many / many-to-one: eg, person-purchases-&gt;sales_order i.e a person can have many orders, but each order will have a single purchaser</li>
  <li>many-to-many: eg, book-author-person i.e a book may have multiple authors, and a person could have authored multiple books</li>
</ul>

<h1 id="modelling-with-flask-sqlalchemy">Modelling with Flask-SQLAlchemy</h1>

<p>Let’s take the Book-Author example and build different relationships between them,</p>

<h3 id="one-to-one">One-to-One</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">"Book"</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s">"author"</span><span class="p">,</span> <span class="n">useList</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1">## add author_id as a foreign key
</span>    <span class="n">author_id</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s">'author.id'</span><span class="p">))</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">Book</code>, there’s only one thing required,</p>

<ul>
  <li>defining the <code class="language-plaintext highlighter-rouge">ForeignKey</code></li>
</ul>

<p>Properties in <code class="language-plaintext highlighter-rouge">book</code>,</p>
<ul>
  <li>id</li>
  <li>author_id</li>
  <li>author (back populated)</li>
</ul>

<p>In <code class="language-plaintext highlighter-rouge">Author</code>, there are 3 things happening,</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">relationship</code> function returns a function that can load <code class="language-plaintext highlighter-rouge">book</code> instances for the property</li>
  <li><code class="language-plaintext highlighter-rouge">useList=False</code> ensures that only a single <code class="language-plaintext highlighter-rouge">Book</code> instance is expected and loaded, hence conslidating the one-to-one relationship</li>
  <li><code class="language-plaintext highlighter-rouge">back_populates='author'</code> back populates <code class="language-plaintext highlighter-rouge">book.author</code> in the <code class="language-plaintext highlighter-rouge">Book</code> instance</li>
</ul>

<p>Properties in <code class="language-plaintext highlighter-rouge">author</code>,</p>
<ul>
  <li>id</li>
  <li>book
    <h2 id="one-to-many--many-to-one">One-to-Many // Many-to-One</h2>
  </li>
</ul>

<p>The above one-to-one mapping can be easily converted to a one-to-many relationship by removing the <code class="language-plaintext highlighter-rouge">useList=False</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">books</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">"Book"</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s">"author"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1">## add author_id as a foreign key
</span>    <span class="n">author_id</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s">'author.id'</span><span class="p">))</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">Book</code>, there’s only one thing required,</p>

<ul>
  <li>defining the <code class="language-plaintext highlighter-rouge">ForeignKey</code></li>
</ul>

<p>Properties in <code class="language-plaintext highlighter-rouge">book</code>,</p>
<ul>
  <li>id</li>
  <li>author_id</li>
  <li>author (back populated)</li>
</ul>

<p>In <code class="language-plaintext highlighter-rouge">Author</code>, there are 3 things happening,</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">relationship</code> function returns a function that can load <code class="language-plaintext highlighter-rouge">book</code> instances for the property</li>
  <li>removing <code class="language-plaintext highlighter-rouge">useList=True</code> allows for loading multiple book instances, hence conslidating the many-to-one relationship</li>
  <li><code class="language-plaintext highlighter-rouge">back_populates='author'</code> back populates <code class="language-plaintext highlighter-rouge">book.author</code> in the <code class="language-plaintext highlighter-rouge">Book</code> instances</li>
</ul>

<p>Properties in <code class="language-plaintext highlighter-rouge">author</code>,</p>
<ul>
  <li>id</li>
  <li>books (an array)</li>
</ul>

<h2 id="many-to-many">Many-to-many</h2>
<p>Many to many is done by adding an association table between classes. The association table is denoted by the <code class="language-plaintext highlighter-rouge">secondary</code> argument.
The <code class="language-plaintext highlighter-rouge">backref</code> parameter automatically uses the same relationship.secondary argument for the reverse relationship.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">association_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s">'association'</span><span class="p">,</span> <span class="n">Base</span><span class="p">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">'author'</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s">'author.id'</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">'book'</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s">'book.id'</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">books</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">"Book"</span><span class="p">,</span>
                    <span class="n">secondary</span><span class="o">=</span><span class="n">association_table</span><span class="p">,</span>
                    <span class="n">backref</span><span class="o">=</span><span class="s">"authors"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>Properites in <code class="language-plaintext highlighter-rouge">author</code>,</p>
<ul>
  <li>id</li>
  <li>books</li>
</ul>

<p>Properties in <code class="language-plaintext highlighter-rouge">book</code></p>
<ul>
  <li>id</li>
  <li>authors (backpopulated)</li>
</ul>

<h2 id="some-key-points-from-the-documentation">Some Key Points from the documentation</h2>

<p><a href="https://flask-sqlalchemy.palletsprojects.com/en/2.x/models/#one-to-many-relationships">Documentation</a></p>

<p>Difference between the <code class="language-plaintext highlighter-rouge">relationship</code> function and specifying the <code class="language-plaintext highlighter-rouge">ForeignKey</code></p>
<blockquote>
  <p>Relationships are expressed with the relationship() function. However the foreign key has to be separately declared with the ForeignKey class</p>
</blockquote>

<p>What is the <code class="language-plaintext highlighter-rouge">relationship</code> function?</p>
<blockquote>
  <p>What does db.relationship() do? That function returns a new property that can do multiple things. In this case we told it to point to the Address class and load multiple of those. How does it know that this will return more than one address? Because SQLAlchemy guesses a useful default from your declaration. If you would want to have a one-to-one relationship you can pass uselist=False to relationship().</p>
</blockquote>

<p>What does <code class="language-plaintext highlighter-rouge">backref</code> mean?</p>
<blockquote>
  <p>backref is a simple way to also declare a new property on the Address class. You can then also use my_address.person to get to the person at that address. <code class="language-plaintext highlighter-rouge">back_populates</code> is unidirectional, whereas <code class="language-plaintext highlighter-rouge">backref</code> is bidirectional</p>
</blockquote>

<p>What does <code class="language-plaintext highlighter-rouge">lazy</code> mean?</p>
<blockquote>
  <p>lazy defines when SQLAlchemy will load the data from the database:</p>
</blockquote>

			</article>

			<br />
			<hr />

			<div>
				<div>Was this helpful? Share with friends!</div>
				<div class="social-media-icons">
						<a target="_blank"
								href='https://www.linkedin.com/sharing/share-offsite/?url=https://iamaatoh.com/blog/one-to-many-with-python-flaskalchemy.html'>
								<i class="fa fa-linkedin"></i>
						</a>
						<a target="_blank"
								href='https://twitter.com/intent/tweet?text=Modeling Relationships with Flask-SQLAlchemy by @iamaatoh&url=https://iamaatoh.com/blog/one-to-many-with-python-flaskalchemy.html'>
								<i class="fa fa-twitter"></i>
						</a>
						<a target="_blank"
								href='http://www.reddit.com/submit?url=https://iamaatoh.com/blog/one-to-many-with-python-flaskalchemy.html&title=Modeling+Relationships+with+Flask-SQLAlchemy%20by%20@akshatamohanty'>
								<i class="fa fa-reddit"></i>
						</a>
						<a target="_blank"
								href="http://news.ycombinator.com/submitlink?u=https://iamaatoh.com/blog/one-to-many-with-python-flaskalchemy.html&t=Modeling Relationships with Flask-SQLAlchemy by Akshata Mohanty">
								<i class="fa fa-y-combinator"></i>
						</a>
						<a href="whatsapp://send?text=Modeling+Relationships+with+Flask-SQLAlchemy%20by%20Akshata Mohanty%20https://iamaatoh.com/blog/one-to-many-with-python-flaskalchemy.html"
								data-action="share/whatsapp/share">
								<i class="fa fa-whatsapp"></i>
						</a>
				</div>
			</div>
		</main>

		<footer>
      <footer>
  <small>
    Copyright © 2021
    Akshata Mohanty
  </small>
</footer>
    </footer>
	</body>
